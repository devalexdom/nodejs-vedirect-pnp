"use strict";var e=require("child_process");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=t(require("serialport"));const{Transform:a}=require("stream");class o extends a{constructor(){super({readableObjectMode:!0}),this.buf=Buffer.alloc(0),this.blk={}}_transform(e,t,r){const[a,o]=e.toString().split("\t");if(":"===a[0])return r();this.buf=Buffer.concat([this.buf,Buffer.from([13,10]),e]),"Checksum"===a?(0===this.buf.reduce(((e,t)=>e+t&255),0)&&this.push((e=>{for(let t in e)switch(t){case"V":case"V2":case"V3":case"VS":case"VM":case"DM":case"VPV":case"PPV":case"I":case"I2":case"I3":case"IL":case"P":case"CE":case"SOC":case"TTG":case"AR":case"OR":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"H7":case"H8":case"H9":case"H10":case"H11":case"H12":case"H13":case"H14":case"H15":case"H16":case"H17":case"H18":case"H19":case"H20":case"H21":case"H22":case"H23":case"ERR":case"CS":case"BMV":case"FW":case"FWE":case"PID":case"HSDS":case"MODE":case"AC_OUT_V":case"AC_OUT_I":case"AC_OUT_S":case"WARN":case"MPPT":e[t]=parseInt(e[t]);break;default:e[t]=e[t]}return e})(this.blk)),this.buf=Buffer.alloc(0),this.blk={}):this.blk[a]=o,r()}}const i={768:"BlueSolar MPPT 70|15",41024:"BlueSolar MPPT 75|50",41025:"BlueSolar MPPT 150|35",41026:"BlueSolar MPPT 75|15",41027:"BlueSolar MPPT 100|15",41028:"BlueSolar MPPT 100|30",41029:"BlueSolar MPPT 100|50",41030:"BlueSolar MPPT 150|70",41031:"BlueSolar MPPT 150|100",41033:"BlueSolar MPPT 100|50 rev2",41034:"BlueSolar MPPT 100|30 rev2",41035:"BlueSolar MPPT 150|35 rev2",41036:"BlueSolar MPPT 75|10",41037:"BlueSolar MPPT 150|45",41038:"BlueSolar MPPT 150|60",41039:"BlueSolar MPPT 150|85",41040:"SmartSolar MPPT 250|100",41041:"SmartSolar MPPT 150|100",41042:"SmartSolar MPPT 150|85",41043:"SmartSolar MPPT 75|15",41044:"SmartSolar MPPT 75|10",41045:"SmartSolar MPPT 100|15",41046:"SmartSolar MPPT 100|30",41047:"SmartSolar MPPT 100|50",41048:"SmartSolar MPPT 150|35",41049:"SmartSolar MPPT 150|100 rev2",41050:"SmartSolar MPPT 150|85 rev2",41051:"SmartSolar MPPT 250|70",41052:"SmartSolar MPPT 250|85",41053:"SmartSolar MPPT 250|60",41054:"SmartSolar MPPT 250|45",41055:"SmartSolar MPPT 100|20",41056:"SmartSolar MPPT 100|20 48V",41057:"SmartSolar MPPT 150|45",41058:"SmartSolar MPPT 150|60",41059:"SmartSolar MPPT 150|70",41060:"SmartSolar MPPT 250|85 rev2",41061:"SmartSolar MPPT 250|100 rev2",41062:"BlueSolar MPPT 100|20",41063:"BlueSolar MPPT 100|20 48V",41064:"SmartSolar MPPT 250|60 rev2",41065:"SmartSolar MPPT 250|70 rev2",41066:"SmartSolar MPPT 150|45 rev2",41067:"SmartSolar MPPT 150|60 rev2",41068:"SmartSolar MPPT 150|70 rev2",41069:"SmartSolar MPPT 150|85 rev3",41070:"SmartSolar MPPT 150|100 rev3",41071:"BlueSolar MPPT 150|45 rev2",41072:"BlueSolar MPPT 150|60 rev2",41073:"BlueSolar MPPT 150|70 rev2",41218:"SmartSolar MPPT VE.Can 150/70",41219:"SmartSolar MPPT VE.Can 150/45",41220:"SmartSolar MPPT VE.Can 150/60",41221:"SmartSolar MPPT VE.Can 150/85",41222:"SmartSolar MPPT VE.Can 150/100",41223:"SmartSolar MPPT VE.Can 250/45",41224:"SmartSolar MPPT VE.Can 250/60",41225:"SmartSolar MPPT VE.Can 250/70",41226:"SmartSolar MPPT VE.Can 250/85",41227:"SmartSolar MPPT VE.Can 250/100",41228:"SmartSolar MPPT VE.Can 150/70 rev2",41229:"SmartSolar MPPT VE.Can 150/85 rev2",41230:"SmartSolar MPPT VE.Can 150/100 rev2",41231:"BlueSolar MPPT VE.Can 150/100",41234:"BlueSolar MPPT VE.Can 250/70",41235:"BlueSolar MPPT VE.Can 250/100",41236:"SmartSolar MPPT VE.Can 250/70 rev2",41237:"SmartSolar MPPT VE.Can 250/100 rev2",41238:"SmartSolar MPPT VE.Can 250/85 rev2"};var s,n,c,l,P;!function(e){e[e.Off=0]="Off",e[e["Low power"]=1]="Low power",e[e.Fault=2]="Fault",e[e.Bulk=3]="Bulk",e[e.Absorption=4]="Absorption",e[e.Float=5]="Float",e[e.Storage=6]="Storage",e[e["Equalize (manual)"]=7]="Equalize (manual)",e[e.Inverting=9]="Inverting",e[e["Power supply"]=11]="Power supply",e[e["Starting-up"]=245]="Starting-up",e[e["Repeated absorption"]=246]="Repeated absorption",e[e["Auto equalize / Recondition"]=247]="Auto equalize / Recondition",e[e.BatterySafe=247]="BatterySafe",e[e["External Control"]=252]="External Control"}(s||(s={})),function(e){e[e[""]=0]="",e[e["Battery voltage too high"]=2]="Battery voltage too high",e[e["Charger temperature too high"]=17]="Charger temperature too high",e[e["Charger over current"]=18]="Charger over current",e[e["Charger current reversed"]=19]="Charger current reversed",e[e["Bulk time limit exceeded"]=20]="Bulk time limit exceeded",e[e["Current sensor issue (sensor bias/sensor broken)"]=21]="Current sensor issue (sensor bias/sensor broken)",e[e["Terminals overheated"]=26]="Terminals overheated",e[e["Converter issue (dual converter models only)"]=28]="Converter issue (dual converter models only)",e[e["Input voltage too high (solar panel)"]=33]="Input voltage too high (solar panel)",e[e["Input current too high (solar panel)"]=34]="Input current too high (solar panel)",e[e["Input shutdown (due to excessive battery voltage)"]=38]="Input shutdown (due to excessive battery voltage)",e[e["Input shutdown (due to current flow during off mode)"]=39]="Input shutdown (due to current flow during off mode)",e[e["Lost communication with one of devices"]=65]="Lost communication with one of devices",e[e["Synchronised charging device configuration issue"]=66]="Synchronised charging device configuration issue",e[e["BMS connection lost"]=67]="BMS connection lost",e[e["Network misconfigured"]=68]="Network misconfigured",e[e["Factory calibration data lost"]=116]="Factory calibration data lost",e[e["Invalid/incompatible firmware"]=117]="Invalid/incompatible firmware",e[e["User settings invalid"]=119]="User settings invalid"}(n||(n={})),function(e){e[e.Off=0]="Off",e[e["Voltage or current limited"]=1]="Voltage or current limited",e[e["MPP Tracker active"]=2]="MPP Tracker active"}(c||(c={})),function(e){e[e[""]=0]="",e[e["No input power"]=1]="No input power",e[e["Switched off (power switch)"]=2]="Switched off (power switch)",e[e["Switched off (device mode register) "]=4]="Switched off (device mode register) ",e[e["Remote input"]=8]="Remote input",e[e["Protection active"]=10]="Protection active",e[e.Paygo=20]="Paygo",e[e.BMS=40]="BMS",e[e["Engine shutdown detection"]=80]="Engine shutdown detection",e[e["Analysing input voltage"]=100]="Analysing input voltage"}(l||(l={})),function(e){e[e.MPPT=0]="MPPT",e[e.Inverter=1]="Inverter",e[e.BMV=2]="BMV",e[e.Charger=3]="Charger"}(P||(P={}));class u{constructor(e){this.deviceName=h(e.PID),this.deviceSN=e["SER#"],this.VEDirectData=e}}class S{constructor(e){this.deviceName=h(e.PID),this.deviceSN=e["SER#"],this.deviceType=P[0],this.deviceFirmwareVersion=function(e){const t=e.FW||e.FWE;return"number"==typeof t?t/100:-1}(e),this.batteryVoltage=e.V/1e3,this.batteryCurrent=e.I/1e3,this.statusMessage=s[e.CS],this.errorMessage=n[e.ERR],this.mpptMessage=c[e.MPPT],this.maximumPowerToday=e.H21,this.maximumPowerYesterday=e.H23,this.totalEnergyProduced=e.H19/100,this.energyProducedToday=e.H20/100,this.energyProducedYesterday=e.H22/100,this.photovoltaicPower=e.PPV,this.photovoltaicVoltage=e.VPV/1e3,this.photovoltaicCurrent=this.photovoltaicPower/this.photovoltaicVoltage,this.loadCurrent=e.IL?e.IL/1e3:0,this.loadOutputState=m(e.LOAD),this.relayState=m(e.Relay),this.offReasonMessage=l[e.OR],this.daySequenceNumber=e.HSDS,this.VEDirectData=e}}function h(e){return i[e]?i[e]:"Unknow Victron Device"}function m(e){return"ON"===e||"On"===e}module.exports=class{constructor({veDirectDevicesPath:e="/dev/serial/by-id/"}={}){this.version=.02,this.parameters={veDirectDevicesPath:e},this.listenersStack=[],this.devicesVEDirectData={},this.serialPorts=[],this.fluidModeReady=!1,this.init()}on(e,t){this.listenersStack.push(((r,a)=>{e===r&&t(a)}))}emitEvent(e,t){for(const r of this.listenersStack)r(e,t)}getVictronDeviceSN(e){return e["SER#"]}mapVictronDeviceData(e){const t={};for(const r in e){const a=e[r];"number"==typeof a.MPPT?t[r]=new S(a):t[r]=new u(a)}return t}init(){this.initVEDirectDataFlowFromAllDevices().then((()=>{this.emitEvent("data-ready")})).catch((e=>{this.emitEvent("error",{message:e})}))}stop(){for(const e of this.serialPorts)e.close()}getDevicesData(){return this.mapVictronDeviceData(this.devicesVEDirectData)}updateVEDirectDataDeviceData(e){const t=this.getVictronDeviceSN(e);t?this.devicesVEDirectData=Object.assign(Object.assign({},this.devicesVEDirectData),{[t]:Object.assign(Object.assign({},e),{dataTimeStamp:new Date})}):this.emitEvent("error",{message:"Device does not have a valid serial number.",dataDump:e})}getVEDirectDevicesAvailable(){return new Promise(((t,r)=>{e.exec(`ls ${this.parameters.veDirectDevicesPath}`,((e,a,o)=>{e&&r(e.message),o&&r(o);const i=a.split("\n");i.pop();const s=i.map((e=>this.parameters.veDirectDevicesPath+e));t(s)}))}))}initVEDirectDataFlowFromAllDevices(){return new Promise(((e,t)=>{const r=[];this.getVEDirectDevicesAvailable().then((a=>{for(const e of a)r.push(this.initDataFlowFromVEDirect(e));Promise.all(r).then((()=>{e(!0)}),(e=>{t(e)}))})).catch((e=>{t(e)}))}))}initDataFlowFromVEDirect(e){return new Promise(((t,a)=>{const i=new r.default(e,{baudRate:19200,dataBits:8,parity:"none"},(t=>{t&&(this.emitEvent("error",{message:`Device ${e} serial port error`,dataDump:t}),this.devicesVEDirectData={},a(t))}));this.serialPorts.push(i);const s=new r.default.parsers.Delimiter({delimiter:Buffer.from([13,10],"hex"),includeDelimiter:!1}),n=new o;i.pipe(s).pipe(n),n.on("data",(e=>{this.devicesVEDirectData[this.getVictronDeviceSN(e)]||t(!0),this.updateVEDirectDataDeviceData(e)}))}))}};
